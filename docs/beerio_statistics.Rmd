---
title: "Beerio Statistics"
date: "Updated: `r gsub(' 0', ' ', format(Sys.Date(), format='%b %d, %Y'))`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(googlesheets4)
library(extrafont)
library(ggforce)
library(ggimage)
# ttf_import("../syntax/fonts")
# font_import()
# Sys.setenv(R_GSCMD="C:/Program Files/gs/gs9.50/bin/gswin64c.exe")
# loadfonts(device = "win")
#sheets_auth("cclanfear@gmail.com")
theme_mk8 <- function(){
  theme_minimal(base_size = 14) + 
    theme(title  = element_text(family = "Mario Kart F2"), 
          panel.grid.major.x = element_blank(), 
          panel.grid.minor.x = element_blank())
}
```


```{r processing, include=FALSE}
beerio_sheet_raw <- read_sheet("https://docs.google.com/spreadsheets/d/1V-7lY3NVqVGGEWL-jwwmjYcpLT8mJMN1MI11y-C3Bl0/", sheet = "Data")

beerio_data <- beerio_sheet_raw %>%
  select(-contains("...")) %>%
  filter_all(any_vars(!is.na(.))) %>%
  fill(Date) %>%
  group_by(Date) %>%
  mutate(Day = str_replace(format(Date, "%b %e"), "  ", " ")) %>%
  mutate(Game = row_number()) %>%
  pivot_longer(c(-Date, -Punishment, - Game, -Day), names_to = "Name", values_to = "Score") %>%
  filter(!is.na(Score)) %>%
  ungroup() %>%
  group_by(Name) %>%
  mutate(Player_Game = row_number()) %>%
  ungroup() %>%
  mutate(Punishment = ifelse(is.na(Punishment), "None", Punishment)) %>%
  mutate(Punished = str_remove(str_extract(Punishment, "-> [A-Za-z]*"), "-> ")) %>% 
  mutate(Punisher = str_remove(str_extract(Punishment, "[A-Za-z]* ->"), " ->")) %>%
  mutate(Punishment = ifelse(Name == Punished, paste0("Punished by ", ifelse(Punisher==Punished, "themself", Punisher)), NA) )

last_players <- beerio_data %>%
  filter(Date ==  max(Date)) %>%
  distinct(Name) %>% pull(Name)

if(length(last_players)==2){
  last_players_text <- paste(last_players, collapse = " and ")
} else {
  last_players_text <- paste(
    paste(last_players[-length(last_players)], collapse = ", "), ", and ",
    last_players[length(last_players)], sep="")
}

```

This document tracks Beerio game statistics. The last tracked game occurred on `r str_replace(format(max(beerio_data$Date), "%A, %B %e, %Y"), "  ", " ")` between `r last_players_text`.

# Descriptive Statistics

This table depicts overall Beerio statistics for all tracked players.

```{r, echo=FALSE}
beerio_data %>% 
  group_by(Name) %>% 
  summarize(`Games<br>Played` = n(), 
            `Average<br>Score` = round(mean(Score),1), 
            `Best<br>Score`=max(Score), 
            `Worst<br>Score` = min(Score),
            `Times<br>Punished`=sum(!is.na(Punishment))) %>% 
  mutate(Name = case_when(
    Name == "Chuck" ~ "Chuck <img src = 'img/lightblueshyguy.png' height=20>",
    Name == "Neil" ~ "Neil <img src = 'img/blackshyguy.png' height=20>",
    Name == "Shawn" ~ "Shawn <img src = 'img/catpeach.png' height=20>",
    Name == "Steve" ~ "Steve <img src = 'img/toadette.png' height=20>",
    Name == "Korl" ~ "Korl <img src = 'img/lakitu.png' height=20>",
    Name == "Chad" ~ "Chad <img src = 'img/donkeykong.png' height=20>",
    TRUE ~ paste0(Name, " <img src = 'img/questionmark.png' height=20>")
  )) %>%
  knitr::kable()
```

# Figures

The first figure depicts Beerio scores over games in each day. Punishments are highlighted.

```{r, echo=FALSE, fig.width=10, fig.align='center', dev="png"}
beerio_data %>%
  ggplot(aes(x = Game, y = Score, group = Name, color = Name)) + 
  facet_wrap(~Day, scales = "free_x") + 
  geom_line(size = 2) +
  geom_image(data = beerio_data %>%  
               mutate(Image = case_when(
                 is.na(Punishment) ~ NA_character_,
                 str_detect(Punishment, "themself") ~ "img/banana.png",
                 TRUE ~ "img/blueshell.png")) %>%
               filter(!is.na(Punishment)), 
             aes(x = Game, y = Score, image = Image), 
             size = .125, inherit.aes = FALSE) + ylab("") + scale_color_discrete("") +
  scale_x_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
  geom_mark_circle(aes(label = Name, description = Punishment, filter = !is.na(Punishment)), color = NA) +
  ggtitle("Beerio Scores", subtitle = "Over the course of evenings") +
  theme_mk8() + theme(legend.position="bottom")

score_text <- broom::tidy(lm(Score ~ Game + Name, data = beerio_data), conf.int=TRUE) %>% 
  select(term, estimate, conf.low, conf.high) %>% filter(term == "Game") %>%
  mutate_if(is.numeric, ~ round(.,2)) %>%
  mutate(text_value = paste0(estimate, " (95% CI: ", conf.low, ", ",conf.high, ")")) %>% 
  pull(text_value)

```

The next plot pools the data across evenings to show the change in average score for each player as the evening wears on. Note the trend is relatively similar across players. Each additional game is associated with a score difference of `r score_text`.

```{r echo=FALSE, fig.width=10, fig.align='center', dev="png"}
ggplot(beerio_data, aes(x = Game, y = Score)) + 
  geom_point(aes(color=Name)) + 
  geom_smooth(method="lm", aes(color=Name, fill =Name), size = 2) + 
  theme_mk8() + ylab("") + scale_fill_discrete("") +
  scale_color_discrete("") +
  ggtitle("Beerio Score Over Games", subtitle = "Regressed on game number") + 
  theme(legend.position = "bottom")
```

The final plot depicts overall score distributions for each player. Wider cross-sections indicate more games with scores in that range.

```{r, echo=FALSE, fig.width=10, fig.align='center', dev="png"}
beerio_data %>%
  ggplot(aes( x = Name, y = Score, fill = Name)) + 
  geom_violin() + 
  xlab("") + 
  ylab("") + 
  theme_mk8() + 
  theme(legend.position = "none") + 
  ggtitle("Beerio Score Distributions")
```

