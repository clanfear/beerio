---
title: "Beerio Statistics"
date: "Updated: `r gsub(' 0', ' ', format(Sys.Date(), format='%b %d, %Y'))`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(googlesheets4)
library(extrafont)
library(ggforce)
library(ggimage)
library(DT)
ttf_import("./fonts")
# font_import()
# Sys.setenv(R_GSCMD="C:/Program Files/gs/gs9.50/bin/gswin64c.exe")
loadfonts(device = "win")
#sheets_auth("cclanfear@gmail.com")
theme_mk8 <- function(){
  theme_minimal(base_size = 14) + 
    theme(title  = element_text(family = "Mario Kart F2"), 
          panel.grid.major.x = element_blank(), 
          panel.grid.minor.x = element_blank())
}
```


```{r processing, include=FALSE}
beerio_sheet_raw <- read_sheet("https://docs.google.com/spreadsheets/d/1V-7lY3NVqVGGEWL-jwwmjYcpLT8mJMN1MI11y-C3Bl0/", sheet = "Data")

beerio_data <- beerio_sheet_raw %>%
  select(-contains("...")) %>%
  filter_all(any_vars(!is.na(.))) %>%
  fill(Date) %>%
  group_by(Date) %>%
  mutate(Day = str_replace(format(Date, "%b %e"), "  ", " ")) %>%
  mutate(Game = row_number()) %>%
  pivot_longer(c(-Date, -Punishment, - Game, -Day), names_to = "Name", values_to = "Score") %>%
  filter(!is.na(Score)) %>%
  ungroup() %>%
  group_by(Name) %>%
  mutate(Player_Game = row_number()) %>%
  ungroup() %>%
  mutate(Punishment = ifelse(is.na(Punishment), "None", Punishment)) %>%
  mutate(Punished = str_remove(str_extract(Punishment, "-> [A-Za-z]*"), "-> ")) %>% 
  mutate(Punisher = str_remove(str_extract(Punishment, "[A-Za-z]* ->"), " ->")) %>%
  mutate(Punishment = ifelse(Name == Punished, paste0("Punished by ", ifelse(Punisher==Punished, "themself", Punisher)), NA) ) %>%
  mutate(Give_and_Take = case_when(
    is.na(Punished) & is.na(Punisher) ~ "No Shot",
    Punished == Name ~ "Take",
    Punisher == Name ~ "Give"
  ))

last_players <- beerio_data %>%
  filter(Date ==  max(Date)) %>%
  distinct(Name) %>% pull(Name)

if(length(last_players)==2){
  last_players_text <- paste(last_players, collapse = " and ")
} else {
  last_players_text <- paste(
    paste(last_players[-length(last_players)], collapse = ", "), ", and ",
    last_players[length(last_players)], sep="")
}

n_recent_games <- beerio_data %>%
  filter(Date ==  max(Date)) %>% pull(Game) %>% max()
```

This document tracks Beerio game statistics. The last tracked `r ifelse(n_recent_games > 1, "games were", "game was")` `r ifelse(n_recent_games==1, "one", n_recent_games)` `r ifelse(n_recent_games > 1, "games", "game")` played on `r str_replace(format(max(beerio_data$Date), "%A, %B %e, %Y"), "  ", " ")` by `r last_players_text`.

# All Game Data

This table contains scores and events for all logged games. It is searchable and sortable on all columns.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
all_games <- beerio_data %>% select(Date, Game, Name, Score) %>%
  pivot_wider(names_from = Name, values_from = Score) %>%
  left_join(beerio_data %>% filter(Give_and_Take == "Take") %>% select(Date, Game, Name, Punishment) %>%
    group_by(Date, Game) %>% summarize(Events = str_c(str_c(Name, " ", Punishment), collapse = ", ")) %>% 
    select(Date, Game, Events)) %>%
  arrange(desc(Date)) %>%
  mutate(Date = str_replace(format(Date, "%A, %B %e, %Y"), "  ", " "))
# datatable(all_games, options = list(pageLength = 10, scrollY=FALSE, paging=TRUE, info=TRUE), escape=FALSE, autoHideNavigation=TRUE, rownames=FALSE)

DT::datatable({
  all_games %>% mutate_all(~as.character(.))
},
callback = JS("
  $.fn.dataTableExt.oSort['NumericOrBlank-asc'] = function(x,y) {
    var retVal;
        if( x === '' || $.isEmptyObject(x)) x = 1000;
    if( y === '' || $.isEmptyObject(y)) y = 1000;
    x = (x = parseFloat($.trim(x).replace(/,/g,''))) ? x : 0;
    y = (y = parseFloat($.trim(y).replace(/,/g,''))) ? y : 0;
    if (x==y) retVal= 0; 
    else retVal = (x>y) ? 1 : -1; 
    return retVal;
  };
  $.fn.dataTableExt.oSort['NumericOrBlank-desc'] = function(y,x) {
  var retVal;
  x = (x = parseFloat($.trim(x).replace(/,/g,''))) ? x : 0;
  y = (y = parseFloat($.trim(y).replace(/,/g,''))) ? y : 0;
  if (x==y) retVal= 0; 
  else retVal = (x>y) ? 1 : -1; 
  return retVal;
  };
  "),
options = list(
  autoWidth = TRUE,
  pageLength = 10, scrollY=FALSE, paging=TRUE, info=TRUE,
  aoColumnDefs = list(
    list(width = '45px',  bSortable = TRUE, sType = 'NumericOrBlank', targets = c(1,2,3,4,5)),
    list(width = '250px', bSortable = TRUE, sType = 'NumericOrBlank', targets = c(6)))
), escape=FALSE, autoHideNavigation=TRUE, rownames=FALSE)

```



# Descriptive Statistics

This table depicts overall Beerio statistics for all tracked players.

```{r, echo=FALSE, warning=FALSE, message=FALSE}
beerio_table <- beerio_data %>% 
  group_by(Name) %>% 
  summarize(`Games<br>Played` = n(), 
            `Average<br>Score` = round(mean(Score),1), 
            `Best<br>Score`=max(Score), 
            `Worst<br>Score` = min(Score),
            `Times<br>Punished`=sum(!is.na(Punishment)),
            `Times<br>Punisher`=sum(Give_and_Take=="Give")) %>% 
  mutate(Name = case_when(
    Name == "Chuck" ~ "<img src = 'img/lightblueshyguy.png' height=20> Chuck",
    Name == "Neil" ~ "<img src = 'img/blackshyguy.png' height=20> Neil",
    Name == "Shawn" ~ "<img src = 'img/catpeach.png' height=20> Shawn",
    Name == "Steve" ~ "<img src = 'img/toadette.png' height=20> Steve",
    Name == "Korl" ~ "<img src = 'img/lakitu.png' height=20> Korl",
    Name == "Chad" ~ "<img src = 'img/donkeykong.png' height=20> Chad",
    TRUE ~ paste0(Name, " <img src = 'img/questionmark.png' height=20>")
  ))
  datatable(beerio_table, options = list(pageLength = 10, searching=FALSE, lengthChange=FALSE, scrollY=FALSE, paging=FALSE, info=FALSE), escape=FALSE, autoHideNavigation=TRUE, rownames=FALSE)
```

# Figures

The first figure depicts Beerio scores over games in each day. Punishments are indicated by a blue shell. Days with only one game are excluded.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.align='center', dev="png"}
beerio_data %>%
  group_by(Date) %>%
  filter(max(Game) > 1) %>%
  ungroup() %>%
  ggplot(aes(x = Game, y = Score, group = Name, color = Name)) + 
  facet_wrap(~Day, scales = "free_x") + 
  geom_line(size = 2) +
  geom_image(data = beerio_data %>%  
               mutate(Image = case_when(
                 is.na(Punishment) ~ NA_character_,
                 str_detect(Punishment, "themself") ~ "img/banana.png",
                 TRUE ~ "img/blueshell.png")) %>%
               filter(!is.na(Punishment)), 
             aes(x = Game, y = Score, image = Image), 
             size = .125, inherit.aes = FALSE) + ylab("") + scale_color_discrete("") +
  scale_x_continuous(breaks = function(x) unique(floor(pretty(seq(0, (max(x) + 1) * 1.1))))) +
  geom_mark_circle(aes(label = Name, description = Punishment, filter = !is.na(Punishment)), color = NA) +
  ggtitle("Beerio Scores", subtitle = "Over the course of evenings") +
  theme_mk8() + theme(legend.position="bottom")

score_text <- broom::tidy(lm(Score ~ Game + Name, data = beerio_data), conf.int=TRUE) %>% 
  select(term, estimate, conf.low, conf.high) %>% filter(term == "Game") %>%
  mutate_if(is.numeric, ~ round(.,2)) %>%
  mutate(text_value = paste0(estimate, " (95% CI: ", conf.low, ", ",conf.high, ")")) %>% 
  pull(text_value)

```

The next plot pools the data across evenings to show the change in average score for each player as the evening wears on. Note the trend is relatively similar across players. Each additional game is associated with a score difference of `r score_text`.

```{r echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.align='center', dev="png"}
legend_data <- tibble(x = max(beerio_data$Game)*0.9,
                      y = max(beerio_data$Score)*c(1, 0.90),
                      image = c("img/star.png","img/bomb.png"),
                      text = c("Gave Shot", "Took Shot"))
ggplot(beerio_data, aes(x = Game, y = Score)) + 
  geom_point(aes(fill=Name), size =3, shape  = 21, color = "black") + 
  geom_smooth(method="lm", aes(color=Name, fill =Name), size = 2) + 
  theme_mk8() + ylab("") + scale_fill_discrete("") +
  scale_color_discrete("") +
    geom_image(data = beerio_data %>%  
               filter(!is.na(Punished)) %>%
               mutate(Image = case_when(
                 Give_and_Take == "Take" ~ "img/bomb.png",
                 Give_and_Take == "Give" ~ "img/star.png")) %>% 
               select(Game, Score, Image), 
             aes(x = Game, y = Score, image = Image), 
             size = .05, inherit.aes = FALSE) +
  geom_image(data=legend_data, aes(x=x, y=y, image=image), inherit.aes=FALSE) +
  geom_text(data=legend_data, aes(x=x, y=y, label = text), hjust = 0, nudge_x = 0.25, inherit.aes=FALSE) +
  ggtitle("Beerio Score Over Games", subtitle = "Regressed on game number") + 
  coord_cartesian(ylim = c(0, max(beerio_data$Score+3))) +
  theme(legend.position = "bottom")
```

The final plot depicts overall score distributions for each player. Wider cross-sections indicate more games with scores in that range. Points indicate scores for each match, jittered horizontally to reduce overplotting.

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=10, fig.align='center', dev="png"}

legend_data <- tibble(x = length(unique(beerio_data$Name)),
                      y = max(beerio_data$Score)*c(1, 0.90),
                      image = c("img/star.png","img/bomb.png"),
                      text = c("Gave Shot", "Took Shot"))
                      

beerio_data %>%
  ggplot(aes( x = Name, y = Score, fill = Name)) + 
  geom_violin(show.legend=FALSE) + 
  geom_point(data = beerio_data %>% filter(Give_and_Take == "No Shot"), 
             aes(x = Name, y = Score),  alpha = 0.5, size = 3, 
             position = position_jitter(width = 0.08, height=0), inherit.aes = FALSE) +
  geom_image(data = beerio_data %>%  
               filter(!is.na(Punished)) %>%
               mutate(Image = case_when(
                 Give_and_Take == "Take" ~ "img/bomb.png",
                 Give_and_Take == "Give" ~ "img/star.png")) %>% 
               select(Name, Score, Image), 
             aes(x = Name, y = Score, image = Image), position = position_jitter(width = 0.08, height=0), 
             size = .05, inherit.aes = FALSE) +
  geom_image(data=legend_data, aes(x=x, y=y, image=image), inherit.aes=FALSE) +
  geom_text(data=legend_data, aes(x=x, y=y, label = text), hjust = 0, nudge_x = 0.1, inherit.aes=FALSE) +
  scale_color_manual("Shots", values = c("No Shot" = "black", "Give" = "white", "Take" = "red")) +
  xlab("") + 
  ylab("") + 
  coord_cartesian(ylim = c(0, max(beerio_data$Score+3))) +
  theme_mk8() + 
  theme(legend.position = "bottom", legend.key = element_rect(fill = "gray70", color = NA)) + 
  ggtitle("Beerio Score Distributions")
```

